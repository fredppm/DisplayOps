<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Office TV Debug Monitor</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.85);
      color: #ffffff;
      height: 100vh;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      user-select: none;
      -webkit-app-region: drag;
    }

    .header {
      background: rgba(30, 30, 30, 0.9);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      -webkit-app-region: drag;
    }

    .header-title {
      font-weight: 600;
      font-size: 13px;
      flex: 1;
      color: #4CAF50;
    }

    .header-controls {
      display: flex;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    .header-btn {
      background: none;
      border: none;
      color: #ffffff;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      transition: background-color 0.2s;
    }

    .header-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .header-btn.pin {
      color: #FFC107;
    }

    .header-btn.pin.active {
      background: rgba(255, 193, 7, 0.2);
    }

    .status-bar {
      background: rgba(20, 20, 20, 0.9);
      padding: 6px 12px;
      font-size: 10px;
      display: flex;
      gap: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .status-dot.green { background: #4CAF50; }
    .status-dot.red { background: #F44336; }
    .status-dot.yellow { background: #FFC107; }

    .tabs {
      display: flex;
      background: rgba(40, 40, 40, 0.9);
      -webkit-app-region: no-drag;
    }

    .tab {
      flex: 1;
      padding: 8px 12px;
      cursor: pointer;
      border: none;
      background: none;
      color: #888;
      font-size: 11px;
      transition: all 0.2s;
    }

    .tab.active {
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
      border-bottom: 2px solid #4CAF50;
    }

    .tab:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
      color: #ffffff;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      -webkit-app-region: no-drag;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .event-item {
      padding: 6px 8px;
      margin-bottom: 4px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      border-left: 3px solid #4CAF50;
    }

    .event-item.error {
      border-left-color: #F44336;
    }

    .event-item.warning {
      border-left-color: #FFC107;
    }

    .event-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }

    .event-type {
      font-weight: 600;
      font-size: 10px;
      text-transform: uppercase;
    }

    .event-time {
      font-size: 9px;
      color: #888;
    }

    .event-message {
      font-size: 11px;
      color: #ddd;
      word-wrap: break-word;
    }

    .event-data {
      font-size: 9px;
      color: #888;
      margin-top: 4px;
      padding: 4px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 2px;
      font-family: monospace;
      max-height: 60px;
      overflow-y: auto;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }

    .metric-card {
      background: rgba(255, 255, 255, 0.05);
      padding: 8px;
      border-radius: 4px;
    }

    .metric-label {
      font-size: 9px;
      color: #888;
      text-transform: uppercase;
      margin-bottom: 2px;
    }

    .metric-value {
      font-size: 14px;
      font-weight: 600;
      color: #4CAF50;
    }

    .system-info {
      background: rgba(255, 255, 255, 0.05);
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .system-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
      font-size: 10px;
    }

    .system-label {
      color: #888;
    }

    .system-value {
      color: #ddd;
      font-family: monospace;
    }

    .no-data {
      text-align: center;
      color: #888;
      padding: 20px;
      font-style: italic;
    }

    .scrollable {
      max-height: 280px;
      overflow-y: auto;
    }

    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 2px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .action-buttons {
      display: flex;
      gap: 4px;
      margin-top: 8px;
    }

    .action-btn {
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid #4CAF50;
      color: #4CAF50;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 9px;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: rgba(76, 175, 80, 0.3);
    }

    .loading {
      display: inline-block;
      width: 10px;
      height: 10px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-top: 2px solid #4CAF50;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-title">üêõ Debug Monitor</div>
    <div class="header-controls">
      <button class="header-btn pin" id="pinBtn" title="Pin/Unpin">üìå</button>
      <button class="header-btn" id="minimizeBtn" title="Minimize">‚îÄ</button>
      <button class="header-btn" id="closeBtn" title="Close">‚úï</button>
    </div>
  </div>

  <div class="status-bar">
    <div class="status-item">
      <div class="status-dot green" id="mdnsStatus"></div>
      <span>mDNS</span>
    </div>
    <div class="status-item">
      <div class="status-dot green" id="apiStatus"></div>
      <span>API: <span id="apiCount">0</span>/min</span>
    </div>
    <div class="status-item">
      <span>Windows: <span id="windowCount">0</span></span>
    </div>
    <div class="status-item">
      <span>Uptime: <span id="uptime">0s</span></span>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="events">Events</button>
    <button class="tab" data-tab="metrics">Metrics</button>
    <button class="tab" data-tab="system">System</button>
  </div>

  <div class="content">
    <!-- Events Tab -->
    <div class="tab-content active" id="events">
      <div class="action-buttons">
        <button class="action-btn" id="clearEvents">Clear</button>
        <button class="action-btn" id="exportJson">Export JSON</button>
      </div>
      <div class="scrollable" id="eventsList">
        <div class="no-data">No events yet...</div>
      </div>
    </div>

    <!-- Metrics Tab -->
    <div class="tab-content" id="metrics">
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-label">CPU Usage</div>
          <div class="metric-value"><span id="cpuValue">0</span>%</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Memory</div>
          <div class="metric-value"><span id="memoryValue">0</span>%</div>
        </div>
      </div>
      <div class="scrollable">
        <div class="system-info">
          <div class="system-row">
            <span class="system-label">API Requests/min:</span>
            <span class="system-value" id="apiRequests">0</span>
          </div>
          <div class="system-row">
            <span class="system-label">Active Windows:</span>
            <span class="system-value" id="activeWindows">0</span>
          </div>
          <div class="system-row">
            <span class="system-label">Last Update:</span>
            <span class="system-value" id="lastUpdate">Never</span>
          </div>
        </div>
      </div>
    </div>

    <!-- System Tab -->
    <div class="tab-content" id="system">
      <div class="scrollable">
        <div class="system-info">
          <div class="system-row">
            <span class="system-label">Process ID:</span>
            <span class="system-value" id="processId">-</span>
          </div>
          <div class="system-row">
            <span class="system-label">Node Version:</span>
            <span class="system-value" id="nodeVersion">-</span>
          </div>
          <div class="system-row">
            <span class="system-label">Electron Version:</span>
            <span class="system-value" id="electronVersion">-</span>
          </div>
          <div class="system-row">
            <span class="system-label">Platform:</span>
            <span class="system-value" id="platform">-</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    class DebugOverlay {
      constructor() {
        this.events = [];
        this.metrics = null;
        this.state = { pinned: false, activeTab: 'events' };
        this.init();
      }

      async init() {
        this.setupEventListeners();
        this.setupTabs();
        await this.loadInitialData();
        this.setupRealtimeUpdates();
      }

      setupEventListeners() {
        // Header controls
        document.getElementById('pinBtn').addEventListener('click', () => {
          this.togglePin();
        });

        document.getElementById('minimizeBtn').addEventListener('click', () => {
          window.debugAPI.minimize();
        });

        document.getElementById('closeBtn').addEventListener('click', () => {
          window.debugAPI.close();
        });

        // Action buttons
        document.getElementById('clearEvents').addEventListener('click', async () => {
          await window.debugAPI.clearEvents();
          this.events = [];
          this.renderEvents();
        });

        document.getElementById('exportJson').addEventListener('click', async () => {
          const data = await window.debugAPI.exportEvents('json');
          this.downloadFile('debug-events.json', data);
        });
      }

      setupTabs() {
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            this.switchTab(tabName);
          });
        });
      }

      switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.toggle('active', tab.dataset.tab === tabName);
        });

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.toggle('active', content.id === tabName);
        });

        this.state.activeTab = tabName;
        window.debugAPI.setTab(tabName);
      }

      async loadInitialData() {
        try {
          this.state = await window.debugAPI.getState();
          this.events = await window.debugAPI.getEvents();
          this.metrics = await window.debugAPI.getMetrics();

          this.updatePinButton();
          this.renderEvents();
          this.renderMetrics();
          this.renderSystemInfo();
        } catch (error) {
          console.error('Failed to load initial data:', error);
        }
      }

      setupRealtimeUpdates() {
        window.debugAPI.onUpdate((data) => {
          this.events = data.events || [];
          this.metrics = data.metrics || null;
          
          this.renderEvents();
          this.renderMetrics();
          this.updateStatusBar();
        });
      }

      async togglePin() {
        this.state.pinned = await window.debugAPI.togglePin();
        this.updatePinButton();
      }

      updatePinButton() {
        const pinBtn = document.getElementById('pinBtn');
        pinBtn.classList.toggle('active', this.state.pinned);
        pinBtn.title = this.state.pinned ? 'Unpin' : 'Pin';
      }

      renderEvents() {
        const container = document.getElementById('eventsList');
        
        if (!this.events || this.events.length === 0) {
          container.innerHTML = '<div class="no-data">No events yet...</div>';
          return;
        }

        container.innerHTML = this.events.map(event => {
          const time = new Date(event.timestamp).toLocaleTimeString();
          const typeClass = event.type === 'error' ? 'error' : 
                           event.type === 'warning' ? 'warning' : '';

          return `
            <div class="event-item ${typeClass}">
              <div class="event-header">
                <span class="event-type">${event.category}</span>
                <span class="event-time">${time}</span>
              </div>
              <div class="event-message">${event.message}</div>
              ${event.data ? `<div class="event-data">${JSON.stringify(event.data, null, 2)}</div>` : ''}
              ${event.duration ? `<div class="event-time">Duration: ${event.duration}ms</div>` : ''}
            </div>
          `;
        }).join('');
      }

      renderMetrics() {
        if (!this.metrics) return;

        document.getElementById('cpuValue').textContent = this.metrics.cpu;
        document.getElementById('memoryValue').textContent = this.metrics.memory;
        document.getElementById('apiRequests').textContent = this.metrics.apiRequestsPerMinute;
        document.getElementById('activeWindows').textContent = this.metrics.activeWindows;
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
      }

      renderSystemInfo() {
        document.getElementById('processId').textContent = process.pid || '-';
        document.getElementById('nodeVersion').textContent = process.versions?.node || '-';
        document.getElementById('electronVersion').textContent = process.versions?.electron || '-';
        document.getElementById('platform').textContent = process.platform || '-';
      }

      updateStatusBar() {
        if (!this.metrics) return;

        // Update status dots
        const mdnsStatus = document.getElementById('mdnsStatus');
        const apiStatus = document.getElementById('apiStatus');
        
        mdnsStatus.className = `status-dot ${this.metrics.mdnsStatus === 'active' ? 'green' : 'red'}`;
        apiStatus.className = 'status-dot green'; // API is running if we get updates

        // Update counters
        document.getElementById('apiCount').textContent = this.metrics.apiRequestsPerMinute;
        document.getElementById('windowCount').textContent = this.metrics.activeWindows;
        document.getElementById('uptime').textContent = this.formatUptime(this.metrics.uptime);
      }

      formatUptime(seconds) {
        if (seconds < 60) return `${Math.floor(seconds)}s`;
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
        return `${Math.floor(seconds / 3600)}h`;
      }

      downloadFile(filename, data) {
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      new DebugOverlay();
    });

    // Cleanup on unload
    window.addEventListener('beforeunload', () => {
      window.debugAPI?.removeAllListeners?.();
    });
  </script>
</body>
</html>
